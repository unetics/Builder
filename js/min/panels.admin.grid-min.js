/**
 * Grid layout for the Panel interface
 *
 * @copyright Greg Priday 2013
 * @license GPL 2.0 http://www.gnu.org/licenses/gpl-2.0.html
 */
!function($){var e=0,n=0;$.fn.panelsResizeCells=function(){return $(this).each(function(){var e=$(this);e.find(".grid, .grid .cell, .grid .cell .cell-wrapper").css("height","auto");var n=e.find(".grid").outerWidth();e.find(".grid .cell").length>1&&e.find(".grid .cell").each(function(){n-=$(this).is(".first, .last")?6:12});var i=0,t=0;e.find(".grid .cell").each(function(){t=Math.max(t,$(this).height()),$(this).width(Math.floor(n*Number($(this).attr("data-percent")))).css("left",i),i+=$(this).width()+12}),e.find(".grid, .grid .cell, .grid .cell .cell-wrapper").css("height",Math.max(t,68))})},panels.createGrid=function(i,t,a){if(null==t||0==t.length){t=[];for(var l=0;i>l;l++)t[l]=1}"undefined"==typeof a&&(a={});var s=0;for(var d in t)s+=t[d];var r=$("<div />").addClass("grid-container").appendTo("#panels-container");r.append($('<input type="hidden" name="grids['+e+'][cells]" />').val(i));var c={};for(var o in panelsStyleFields)c[o]=$('<input type="hidden" name="grids['+e+"][style]["+o+']" data-style-field="'+o+'" />').appendTo(r),"undefined"!=typeof a[o]&&c[o].val("checkbox"==panelsStyleFields[o].type?a[o]?"true":"":a[o]);r.append($('<div class="controls" />').append($('<div class="ui-button ui-button-icon-only"><div class="dashicons dashicons-trash"></div></div>').attr("data-tooltip","delete").click(function(){$(this).panelsRemoveTooltip();var e=[];r.find(".cell").each(function(n,i){e[n]={weight:Number($(this).attr("data-percent")),widgets:[]},$(this).find(".panel").each(function(i,t){e[n].widgets[i]={type:$(this).attr("data-type"),data:$(this).panelsGetPanelData()}})}),window.panels.undoManager.register(this,function(e,n){for(var i=[],t=0;t<e.length;t++)i[t]=e[t].weight;for(var a=window.panels.createGrid(i.length,i),t=0;t<e.length;t++)for(var l=0;l<e[t].widgets.length;l++){var s=e[t].widgets[l],d=$("#panels-dialog").panelsCreatePanel(s.type,s.data);window.panels.addPanel(d,a.find(".panels-container").eq(t))}if(n!=a.index()){var r=$("#panels-container .grid-container").eq(n);r.length&&(a.insertBefore(r),$("#panels-container").sortable("refresh"),$("#panels-container").find(".cell").each(function(){$(this).find('input[name$="[grid]"]').val($("#panels-container .grid-container").index($(this).closest(".grid-container")))}),$("#panels-container .panels-container").trigger("refreshcells"))}$("#panels-container .panel").removeClass("new-panel"),panels.animations?a.hide().slideDown():a.show()},[e,r.index()],"Remove Columns"),$("#panels-undo-message").remove(),$('<div id="panels-undo-message" class="updated"><p>Columns deleted - <a href="#" class="undo">Undo</a></p></div>').appendTo("body").hide().fadeIn().find("a.undo").click(function(){return window.panels.undoManager.undo(),$("#panels-undo-message").fadeOut(function(){$(this).remove()}),!1});var n=function(){r.remove(),$("#panels-container").sortable("refresh").find(".panels-container").trigger("refreshcells")};return panels.animations?r.slideUp(n):(r.hide(),n()),!1})).append($('<div class="ui-button ui-button-icon-only panels-visual-style"><div class="dashicons dashicons-admin-generic"></div></div>').attr("data-tooltip","Row Settings").click(function(){panels.loadStyleValues(r)})).append($('<div class="ui-button ui-button-icon-only grid-handle"><div class="dashicons dashicons-sort"></div></div>'))),Object.keys(panelsStyleFields).length||r.find(".panels-visual-style").remove();for(var p=$("<div />").addClass("grid").appendTo(r),l=0;i>l;l++){var h=$('<div class="cell" data-percent="'+t[l]/s+'"><div class="cell-wrapper panels-container"></div><div class="cell-width"><div class="cell-width-left"></div><div class="cell-width-right"></div><div class="cell-width-line"></div><div class="cell-width-value"><span></span></div></div></div>');0==l&&h.addClass("first"),l==i-1&&h.addClass("last"),p.append(h),h.append($('<input type="hidden" name="grid_cells['+n+'][weight]" />').val(t[l]/s)).append($('<input type="hidden" name="grid_cells['+n+'][grid]" />').val(e)).data("cellId",n),n++}return p.append($("<div />").addClass("clear")),e++,panels.setupGrid(r),r},panels.setupGrid=function(e){$("#panels-undo-message").fadeOut(function(){$(this).remove()}),e.panelsResizeCells(),e.find(".grid .cell").not(".first").each(function(){var n,i;$(this).resizable({handles:"w",containment:"parent",start:function(e,t){n=$(this).prev().outerWidth(),i=$(this).prev().position().left},stop:function(n,i){e.find(".grid .cell").not(".first").resizable("disable").resizable("enable")},resize:function(n,i){var t=$(this),a=$(this).prev();a.css("width",t.position().left-a.position().left-12);var l=0;e.find(".grid .cell").each(function(){l+=$(this).width()}).each(function(){var e=$(this).width()/l;$(this).find(".cell-width-value span").html(Math.round(1e3*e)/10+"%"),$(this).attr("data-percent",e).find('input[name$="[weight]"]').val(e)}),e.panelsResizeCells()}})}),e.find(".grid .cell .ui-resizable-handle").dblclick(function(){var n=$(this).closest(".cell"),i=n.prev(),t=Number(n.attr("data-percent"))+Number(i.attr("data-percent"));return n.attr("data-percent",t/2).find('input[name$="[weight]"]').val(t/2),i.attr("data-percent",t/2).find('input[name$="[weight]"]').val(t/2),n.add(i).find(".cell-width-value span").html(Math.round(t/2*1e3)/10+"%"),e.panelsResizeCells(),!1}),e.find(".grid .cell").click(function(){$(".grid .cell").removeClass("cell-selected"),$(this).addClass("cell-selected")}).each(function(){var e=Number($(this).attr("data-percent"));$(this).find(".cell-width-value span").html(Math.round(1e3*e)/10+"%")}).find(".panels-container").sortable({placeholder:"ui-state-highlight",connectWith:".panels-container",tolerance:"pointer",change:function(e){var n=$("#panels-container .ui-state-highlight").closest(".cell").get(0);"undefined"!=typeof this.lastContainer&&this.lastContainer!=n&&($(this.lastContainer).closest(".grid-container").panelsResizeCells(),$(n).closest(".grid-container").panelsResizeCells(),n.click()),this.lastContainer=n},helper:function(e,n){return n.clone().css("opacity",panels.animations?.9:1).addClass("panel-being-dragged")},stop:function(e,n){$("#panels-container .grid-container").each(function(){$(this).panelsResizeCells()})},receive:function(){$(this).trigger("refreshcells")}}).bind("refreshcells",function(){$("#panels-container .panel").each(function(){var e=$(this).closest(".grid-container");$(this).find('input[name$="[info][grid]"]').val($("#panels-container .grid-container").index(e)),$(this).find('input[name$="[info][cell]"]').val(e.find(".cell").index($(this).closest(".cell")))}),$("#panels-container .cell").each(function(){$(this).find('input[name$="[grid]"]').val($("#panels-container .grid-container").index($(this).closest(".grid-container")))})})},panels.clearGrids=function(){$("#panels-container .grid-container").remove()}}(jQuery);