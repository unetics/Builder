/**
 * Main admin control for the Panel interface
 *
 * @copyright Greg Priday 2013
 * @license GPL 2.0 http://www.gnu.org/licenses/gpl-2.0.html
 */
!function($){var e=0;panels.undoManager=new UndoManager,$.fn.panelsGetPanelData=function(){var e=$(this),n={},a;return e.data("missing")===!0?n=JSON.parse(e.find('input[name$="[data]"]').val()):"undefined"==typeof e.data("dialog")||e.data("dialog").hasClass("ui-dialog-content-loading")?n=""==e.find('input[name$="[data]"]').val()?{}:JSON.parse(e.find('input[name$="[data]"]').val()):e.data("dialog").find("*[name]").not("[data-info-field]").each(function(){var e=$(this),i=/widgets\[[0-9]+\]\[(.*)\]/.exec(e.attr("name"));i=i[1],a=i.split("]["),a=a.map(function(e){return!isNaN(parseFloat(e))&&isFinite(e)?parseInt(e):e});for(var t=n,l=0;l<a.length;l++)l==a.length-1?"checkbox"==e.attr("type")?e.is(":checked")&&(t[a[l]]=""!=e.val()?e.val():!0):t[a[l]]=e.val():("undefined"==typeof t[a[l]]&&(t[a[l]]={}),t=t[a[l]])}),n},$.fn.panelsCreatePanel=function(n,a){$("#panels-undo-message").fadeOut(function(){$(this).remove()});var i,t=e++,l=$(this),s=$('<div class="panel new-panel"><div class="panel-wrapper"><div class="title"><h4></h4><span class="actions"></span></div><small class="description"></small></div></div>');s.attr("data-type",n).append($('<input type="hidden" name="widgets['+t+'][data]" type="hidden">').val(JSON.stringify(a))).append($('<input type="hidden" name="widgets['+t+'][info][raw]" type="hidden">').val(0)).append($('<input type="hidden" name="widgets['+t+'][info][grid]" type="hidden">')).append($('<input type="hidden" name="widgets['+t+'][info][cell]" type="hidden">')).append($('<input type="hidden" name="widgets['+t+'][info][id]" type="hidden">').val(t)).append($('<input type="hidden" name="widgets['+t+'][info][class]" type="hidden">').val(n)).append($('<input type="hidden" name="panel_order[]" type="hidden">').val(t)).data("raw",!1).find("h4, h5").click(function(){return $(this).closest(".panel").find("a.edit").click(),!1});var d=l.find(".panel-type").filter(function(){return $(this).data("class")===n});if(0!=d.length)s.data({title:d.data("title")}).find(".description").html(d.find(".description").html()).end().find(".title h4").html(d.find("h3").html());else{if("undefined"==typeof panelsMissingWidgets||"undefined"==typeof panelsMissingWidgets[n])return;s.data({title:panelsMissingWidgets[n].title,missing:!0}).find(".description").html(panelsMissingWidgets[n].description).end().find(".title h4").html(panelsMissingWidgets[n].title)}s.panelsSetPanelTitle(a);var o=function(){panels.undoManager.register(this,function(e,n,a,i){var t=$("#panels-dialog").panelsCreatePanel(e,n,a);panels.addPanel(t,a,i,!0),$("#panels-container .panel").removeClass("new-panel")},[s.attr("data-type"),s.panelsGetPanelData(),s.closest(".panels-container"),s.index()],"Remove Panel"),$("#panels-undo-message").remove(),$('<div id="panels-undo-message" class="updated"><p>Widget deleted - <a href="#" class="undo">Undo</a></p></div>').appendTo("body").hide().slideDown().find("a.undo").click(function(){return panels.undoManager.undo(),$("#panels-undo-message").fadeOut(function(){$(this).remove()}),!1});var e=function(){var e=s.closest(".grid-container");s.remove(),e.panelsResizeCells()};panels.animations?s.slideUp(e):(s.hide(),e())};return s.find(".title .actions").append($('<a><div class="dashicons dashicons-admin-generic"></div><a>').addClass("edit").click(function(){if("undefined"!=typeof i)return!1;var e=!1;i=$('<div class="panel-dialog dialog-form"></div>').data("widget-type",n).addClass("ui-dialog-content-loading").addClass("widget-dialog-"+n.toLowerCase()).dialog({dialogClass:"panels-admin-dialog",autoOpen:!0,modal:!1,draggable:!1,resizable:!1,title:panels.i10n.messages.editWidget.replace("%s",s.data("title")),width:Math.round(.9*$(window).width()),height:Math.round(.875*$(window).height()),create:function(e,n){$(this).closest(".ui-dialog").find(".show-in-panels").show()},open:function(){$(this).closest(".ui-dialog").find("a").blur();var e=$('<div class="siteorigin-panels-ui-widget-overlay ui-widget-overlay ui-front"></div>').css("z-index",80001);$(this).data("overlay",e).closest(".ui-dialog").before(e)},close:function(){e||$(this).trigger("panelsdone",s,i),$(this).data("overlay").remove(),$(this).dialog("destroy").remove(),i=void 0},buttons:[{text:"Done",click:function(){e=!0,$(this).trigger("panelsdone",s,i);var n=s.panelsGetPanelData();0==i.find(".panels-missing-widget-form").length&&(s.find('input[name$="[data]"]').val(JSON.stringify(n)),s.panelsSetPanelTitle(n),s.find('input[name$="[info][raw]"]').val(1)),i.dialog("close")}}]}).keypress(function(e){if(e.keyCode==$.ui.keyCode.ENTER){if($(this).closest(".ui-dialog").find("textarea:focus").length>0)return;return $(this).closest(".ui-dialog").find(".ui-dialog-buttonpane .ui-button:eq(0)").click(),e.preventDefault(),!1}e.keyCode===$.ui.keyCode.ESCAPE&&$(this).closest(".ui-dialog").dialog("close")}),s.data("dialog",i);var a=n;try{a=a.replace("\\\\","\\")}catch(l){return}return $.post(ajaxurl,{action:"so_panels_widget_form",widget:a,instance:JSON.stringify(s.panelsGetPanelData()),raw:s.find('input[name$="[info][raw]"]').val()},function(e){try{e=e.replace(/\{\$id\}/g,t)}catch(n){e=""}i.html(e).dialog("option","position","center");var a=i.find("a.siteorigin-panels-help-link");a.length&&a.attr("target","_blank").prependTo(i.closest(".ui-dialog").find(".ui-dialog-buttonpane")),$(window).resize(),$(document).trigger("panelssetup",s,i),$("#panels-container .panels-container").trigger("refreshcells"),i.removeClass("ui-dialog-content-loading").trigger("panelsopen",s,i)},"html"),!1})).append($('<a><div class="dashicons dashicons-admin-page"></div><a>').addClass("duplicate").click(function(){var e=$("#panels-dialog").panelsCreatePanel(s.attr("data-type"),s.panelsGetPanelData());return window.panels.addPanel(e,s.closest(".panels-container"),null,!1),e.removeClass("new-panel"),!1})).append($('<a><div class="dashicons dashicons-trash"></div><a>').addClass("delete").click(function(){return o(),!1})),s},panels.addPanel=function(e,n,a,i){if(null==n&&(n=$("#panels-container .cell.cell-selected .panels-container").eq(0)),0==n.length&&(n=$("#panels-container .cell .panels-container").eq(0)),0==n.length&&(panels.createGrid(1,[1]),n=$("#panels-container .cell .panels-container").eq(0)),null==a)n.append(e);else{var t=n.find(".panel").eq(a);0==t.length?n.append(e):e.insertBefore(t)}n.sortable("refresh").trigger("refreshcells"),n.closest(".grid-container").panelsResizeCells(),i&&(panels.animations?$("#panels-container .panel.new-panel").hide().slideDown(450,function(){e.find("a.edit").click()}).removeClass("new-panel"):($("#panels-container .panel.new-panel").show().removeClass("new-panel"),e.find("a.edit").click()))},$.fn.panelsSetPanelTitle=function(e){return $(this).each(function(){var n="";if("undefined"!=typeof e)if("undefined"!=typeof e.title&&""!=e.title)n=e.title;else for(var a in e)if("string"==typeof e[a]&&""!=e[a]){n=e[a];break}try{n=n.substring(0,80).replace(/(<([^>]+)>)/gi,"")}catch(i){n=""}$(this).find("h4").html($(this).data("title")+"<span>"+n+"</span>")})},panels.loadPanels=function(e){if(panels.clearGrids(),"undefined"!=typeof e&&"undefined"!=typeof e.grids)for(var n in e.grids){var a=[];for(var i in e.grid_cells)Number(e.grid_cells[i].grid)==n&&(a[a.length]=Number(e.grid_cells[i].weight));var t=panels.createGrid(Number(e.grids[n].cells),a,e.grids[n].style);for(var l in e.widgets)if("undefined"!=typeof e.widgets[l].info&&Number(e.widgets[l].info.grid)==n){var s=e.widgets[l],d=$("#panels-dialog").panelsCreatePanel(s.info["class"],s);t.find(".panels-container").eq(Number(e.widgets[l].info.cell)).append(d)}}$("#panels-container .panels-container").sortable("refresh").trigger("refreshcells"),$("#panels-container .panel").removeClass("new-panel"),$("#panels-container .grid-container").each(function(){$(this).panelsResizeCells()})}}(jQuery);